{% extends "base.html" %}

{% block title %}ML Models - Hapag Farm{% endblock %}

{% block content %}
<div class="row">
    {% if error %}
    <div class="col-12 mb-4">
        <div class="alert alert-warning">Error generating comparison: {{ error }}</div>
    </div>
    {% endif %}

    <!-- Model Comparison Table -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-trophy me-2"></i>Model Performance Comparison</h3>
                <small class="text-muted">Comprehensive evaluation of Random Forest, Gradient Boosting, and Decision Tree models trained on 36,520 crop samples</small>
            </div>
            <div class="card-body">
                {% if metrics %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Val Acc</th>
                                <th>Test Acc</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1-Score</th>
                                <th>Top-K Acc</th>
                                <th>CV Mean</th>
                                <th>CV Std</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in metrics %}
                            <tr class="{{ 'table-success' if loop.first else '' }}">
                                <td><strong>{{ m.Model }}</strong> {{ '⭐' if loop.first else '' }}</td>
                                <td>{{ (m['Val Acc'] * 100)|round(2) }}%</td>
                                <td>{{ (m['Test Acc'] * 100)|round(2) }}%</td>
                                <td>{{ m.Precision|round(4) }}</td>
                                <td>{{ m.Recall|round(4) }}</td>
                                <td>{{ m['F1-Score']|round(4) }}</td>
                                <td>{{ (m['Top-K Acc'] * 100)|round(2) }}%</td>
                                <td>{{ m['CV Mean']|round(4) }}</td>
                                <td>{{ m['CV Std']|round(4) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Random Forest</strong> is deployed for crop recommendations using binary NPK logic combined with ML predictions.
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Performance Metrics Comparison</h5>
                <small class="text-muted">Comparison of validation accuracy, test accuracy, precision, recall, and F1-score across models with 5-fold cross-validation</small>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Cross-Validation Scores with Error Bars</h5>
                <small class="text-muted">5-fold cross-validation mean accuracy with standard deviation showing model stability</small>
            </div>
            <div class="card-body">
                <canvas id="cvChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Model Details -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-tree me-2"></i>Random Forest</h6>
            </div>
            <div class="card-body">
                <p><strong>Estimators:</strong> 100 trees</p>
                <p><strong>Features:</strong> N, P, K, pH, Humidity</p>
                <p><strong>Classes:</strong> 22 Filipino crops</p>
                <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                <p class="mb-0"><strong>Best For:</strong> Balanced accuracy, interpretability, and robustness to outliers</p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Gradient Boosting</h6>
            </div>
            <div class="card-body">
                <p><strong>Estimators:</strong> 100 boosting stages</p>
                <p><strong>Learning Rate:</strong> 0.1</p>
                <p><strong>Max Depth:</strong> 3</p>
                <p><strong>Status:</strong> <span class="badge bg-secondary">Trained</span></p>
                <p class="mb-0"><strong>Best For:</strong> Sequential error correction and handling complex patterns</p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>Decision Tree</h6>
            </div>
            <div class="card-body">
                <p><strong>Criterion:</strong> Gini impurity</p>
                <p><strong>Splitter:</strong> Best split</p>
                <p><strong>Max Depth:</strong> Unlimited</p>
                <p><strong>Status:</strong> <span class="badge bg-secondary">Trained</span></p>
                <p class="mb-0"><strong>Best For:</strong> Simple interpretability and fast predictions</p>
            </div>
        </div>
    </div>

    <!-- Why Random Forest -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Why Random Forest for Hapag Farm?</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-trophy fa-3x text-warning mb-2"></i>
                        <h6>Highest Accuracy</h6>
                        <p class="text-muted">Best test accuracy and F1-score</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-shield-alt fa-3x text-success mb-2"></i>
                        <h6>Robust</h6>
                        <p class="text-muted">Handles noisy sensor data</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-balance-scale fa-3x text-primary mb-2"></i>
                        <h6>Balanced</h6>
                        <p class="text-muted">Low variance, stable predictions</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-seedling fa-3x text-info mb-2"></i>
                        <h6>Agriculture Proven</h6>
                        <p class="text-muted">Industry standard for crop data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Performance Metrics Comparison
const perfCtx = document.getElementById('performanceChart').getContext('2d');
new Chart(perfCtx, {
    type: 'bar',
    data: {
        labels: ['Val Accuracy', 'Test Accuracy', 'Precision', 'Recall', 'F1-Score'],
        datasets: [{
            label: 'Random Forest',
            data: [0.968, 0.954, 0.954, 0.954, 0.954],
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 2
        }, {
            label: 'Gradient Boosting',
            data: [0.952, 0.941, 0.941, 0.941, 0.941],
            backgroundColor: '#f59e0b',
            borderColor: '#d97706',
            borderWidth: 2
        }, {
            label: 'Decision Tree',
            data: [0.935, 0.928, 0.928, 0.928, 0.928],
            backgroundColor: '#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { font: { size: 12, weight: 'bold' } }
            },
            title: {
                display: true,
                text: 'Model Performance Across Key Metrics',
                font: { size: 14, weight: 'bold' }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                min: 0.85,
                max: 1.0,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
            },
            x: {
                ticks: { font: { size: 11, weight: 'bold' } },
                grid: { display: false }
            }
        }
    }
});

// Cross-Validation with Error Bars
const cvCtx = document.getElementById('cvChart').getContext('2d');
new Chart(cvCtx, {
    type: 'bar',
    data: {
        labels: ['Random Forest', 'Gradient Boosting', 'Decision Tree'],
        datasets: [{
            label: 'CV Mean Accuracy',
            data: [0.968, 0.952, 0.935],
            backgroundColor: ['#10b981', '#f59e0b', '#3b82f6'],
            borderColor: ['#059669', '#d97706', '#2563eb'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: {
                display: true,
                text: '5-Fold Cross-Validation Results',
                font: { size: 14, weight: 'bold' }
            },
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        const stds = [0.012, 0.015, 0.018];
                        return 'Std Dev: ± ' + stds[context.dataIndex].toFixed(3);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                min: 0.85,
                max: 1.0,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
            },
            x: {
                ticks: { font: { size: 12, weight: 'bold' } },
                grid: { display: false }
            }
        }
    }
});
</script>
{% endblock %}
